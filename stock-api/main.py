from fastapi import FastAPI, Query
from fastapi.middleware.cors import CORSMiddleware
from fastapi_utils.tasks import repeat_every
import httpx
import os
from dotenv import load_dotenv
import yfinance as yf

load_dotenv("../.env.local")
FMP_API_KEY = os.getenv("FMP_API_KEY")

app = FastAPI(title="Stock API")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

cached_gainers: list = []
cached_losers: list = []
cached_news: list = []
cached_summary: list = []

def fetch_market_summary():
    """Fetch S&P 500, Dow, and Nasdaq data from Yahoo Finance."""
    global cached_summary
    if cached_summary:
        return cached_summary

    indices = [
        {"symbol": "^GSPC", "name": "S&P 500"},
        {"symbol": "^DJI", "name": "DOW"},
        {"symbol": "^IXIC", "name": "Nasdaq"},
    ]

    summary = []
    for idx in indices:
        ticker = yf.Ticker(idx["symbol"])
        hist = ticker.history(period="1d")
        if not hist.empty:
            latest = hist.iloc[-1]
            change = latest["Close"] - latest["Open"]
            change_percent = (change / latest["Open"]) * 100
            summary.append({
                "symbol": idx["symbol"],
                "name": idx["name"],
                "price": round(latest["Close"], 2),
                "change": round(change, 2),
                "changePercent": round(change_percent, 2),
            })

    cached_summary = summary
    return summary

@app.on_event("startup")
@repeat_every(seconds=30 * 60, raise_exceptions=True)
async def fetch_stocks():
    """Fetch and cache top gainers/losers from FMP every 30 minutes."""
    global cached_gainers, cached_losers
    async with httpx.AsyncClient() as client:
        try:
            gainers_res = await client.get(
                f"https://financialmodelingprep.com/stable/biggest-gainers?apikey={FMP_API_KEY}"
            )
            if gainers_res.status_code == 200:
                cached_gainers = gainers_res.json()

            losers_res = await client.get(
                f"https://financialmodelingprep.com/stable/biggest-losers?apikey={FMP_API_KEY}"
            )
            if losers_res.status_code == 200:
                cached_losers = losers_res.json()

        except Exception as e:
            print("⚠️ Error fetching stocks:", e)


@app.on_event("startup")
@repeat_every(seconds=8 * 60 * 60, raise_exceptions=True)
async def fetch_news():
    """Fetch and cache financial news from FMP every 8 hours."""
    global cached_news
    async with httpx.AsyncClient() as client:
        try:
            news_res = await client.get(
                f"https://financialmodelingprep.com/stable/fmp-articles?page=0&limit=20&apikey={FMP_API_KEY}"
            )
            if news_res.status_code == 200:
                cached_news = news_res.json()
        except Exception as e:
            print("⚠️ Error fetching news:", e)

@app.get("/stocks/gainers")
def get_gainers(n: int = None):
    """Return cached top gainers."""
    return cached_gainers[:n] if n else cached_gainers


@app.get("/stocks/losers")
def get_losers(n: int = None):
    """Return cached top losers."""
    return cached_losers[:n] if n else cached_losers


@app.get("/stocks/news")
def get_news(n: int = 20):
    """Return cached financial news."""
    return cached_news[:n]


@app.get("/stocks/summary-data")
def get_summary():
    """Return market summary for S&P 500, DOW, NASDAQ."""
    return fetch_market_summary()

@app.get("/stocks/history/{symbol}")
def get_stock_history(
    symbol: str,
    period: str = Query("1mo", description="yfinance period, e.g. 1mo, 3mo, 6mo, 1y, ytd"),
    interval: str = Query("1d", description="yfinance interval, e.g. 1d, 1h, 15m")
):
    """Return historical OHLC candle data for a given symbol."""
    try:
        yf_period = "ytd" if period.lower() == "ytd" else period

        ticker = yf.Ticker(symbol)
        hist = ticker.history(period=yf_period, interval=interval)

        if hist.empty:
            return {"error": f"No historical data found for {symbol}"}

        candles = [
            {
                "time": int(index.timestamp()),
                "open": round(row["Open"], 2),
                "high": round(row["High"], 2),
                "low": round(row["Low"], 2),
                "close": round(row["Close"], 2),
            }
            for index, row in hist.iterrows()
        ]

        return candles

    except Exception as e:
        print(f"⚠️ Error fetching history for {symbol}: {e}")
        return {"error": str(e)}